<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book an Appointment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            text-align: left;
        }

        header {
            background-image: url("header.png");
            background-size: 100% auto;
            background-repeat: no-repeat;
            background-color: #29a9e1;
            padding: 15px 20px;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding-left: 80px;
        }

        .menu-icon {
            font-size: 24px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 15px;
            background: none;
            border: none;
            padding: 10px;
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-size: 2em;
            margin-top: 30px;
        }

        h1 .small-text {
            font-size: 0.5em;
            display: block;
        }

        h1 .highlight {
            color: #000000;
            font-size: 1em;
            font-weight: bold;
        }

        header p {
            margin-top: 5px;
            font-size: 1.1em;
        }

        .hidden-menu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background: #29a9e1;
            color: white;
            padding-top: 60px;
            transition: left 0.3s ease-in-out;
            z-index: 99;
        }

        .hidden-menu.active {
            left: 0;
        }

        .hidden-menu ul {
            list-style: none;
            padding: 0;
        }

        .hidden-menu li {
            padding: 10px;
            text-align: center;
        }

        .hidden-menu a {
            color: black;
            text-decoration: none;
            display: block;
            padding: 10px;
        }

        .hidden-menu a:hover {
            background: #fff;
            border-radius: 20px;
        }

        /* Search Bar Styles */
        .search-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 25px;
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex: 1;
            max-width: 500px;
            min-width: 300px;
        }

        .search-box input {
            border: none;
            outline: none;
            padding: 8px;
            font-size: 16px;
            flex: 1;
            background: transparent;
        }

        .search-box input::placeholder {
            color: #999;
        }

        .search-icon {
            color: #29a9e1;
            font-size: 18px;
            margin-right: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: white;
            border: 2px solid #29a9e1;
            color: #29a9e1;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #29a9e1;
            color: white;
        }

        .results-info {
            text-align: center;
            margin: 10px 20px;
            color: #666;
            font-size: 14px;
        }

        .no-results {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .no-results h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 10px 20px 20px 20px;
            width: 320px;
            height: 740px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            margin: 10px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .card.hidden {
            display: none;
        }

        .card-body {
            flex-grow: 1;
            overflow-y: auto;
        }

        .image-wrapper {
            position: relative;
            width: 100%;
            height: 49%;
            overflow: hidden;
            border-radius: 10px;
        }

        .image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: gold;
            color: black;
            padding: 5px 10px;
            font-weight: bold;
            font-size: 0.8rem;
            border-radius: 5px;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }

        .info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doctor-info {
            text-align: left;
        }

        .doctor-name {
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        .doctor-spec {
            font-size: 1em;
            color: #666;
            margin-top: -8px;
        }

        .doctor-hospital,
        .doctor-address {
            font-size: 0.9rem;
            margin-top: 4px;
            color: #444;
        }

        .doctor-review {
            font-size: 0.8em;
            color: #444;
            margin-top: 10px;
            text-align: justify;
        }

        .schedule {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-top: -30px;
        }

        .schedule p {
            font-weight: bold;
        }

        .schedule-grid {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
        }

        .day-cell,
        .time-cell {
            width: 70px;
            text-align: center;
            font-size: 14px;
        }

        .book-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            display: block;
            width: 100%;
            margin-top: 15px;
        }

        .book-btn:hover {
            background-color: #0b7dda;
        }

        footer {
            text-align: center;
            padding: 15px 0;
            font-size: 0.9em;
            color: #666;
            margin-top: 40px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: unset;
            }

            .filter-buttons {
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <header>
        <div><button class="menu-icon" onclick="toggleMenu()">&#9776;</button></div>
        <h1><span class="small-text">BOOK AN</span> <span class="highlight">APPOINTMENT</span></h1>
        <p>Choose your preferred doctor and schedule an appointment.</p>
    </header>

    <nav id="hiddenMenu" class="hidden-menu">
        <ul>
            <li><a href="patientDashboard.html">Home</a></li>
            <li><a href="patientProfile.html">Profile</a></li>
            <li><a href="appointmentHistory.html">Appointment History</a></li>
            <li><a href="medicalHistory.html">Medical History</a></li>
            <li><a href="services.html">Services</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="index.html">Logout</a></li>
        </ul>
    </nav>

    <!-- Search Container -->
    <div class="search-container">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Search doctors by name, specialization, or hospital..." />
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="Cardiologist">Cardiology</button>
            <button class="filter-btn" data-filter="Dermatologist">Dermatology</button>
            <button class="filter-btn" data-filter="Pediatrician">Pediatrics</button>
            <button class="filter-btn" data-filter="Orthopedic">Orthopedics</button>
            <button class="filter-btn" data-filter="Neurologist">Neurology</button>
        </div>
    </div>

    <div class="results-info" id="resultsInfo"></div>

    <div class="container" id="doctorsContainer">
        <!-- Doctors will be loaded here -->
    </div>

    <div class="no-results" id="noResults" style="display: none;">
        <h3>No doctors found</h3>
        <p>Try adjusting your search criteria or browse all available doctors.</p>
    </div>

    <footer>
        <p>&copy; 2025 Doctor Dashboard</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwCayQZ0JO6DjzQvAT6ToT33I4QXCS_NY",
            authDomain: "login-sample-c3af0.firebaseapp.com",
            projectId: "login-sample-c3af0",
            storageBucket: "login-sample-c3af0.firebasestorage.app",
            messagingSenderId: "372688128666",
            appId: "1:372688128666:web:bbc529c73c4665f95f6d23"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allDoctors = [];
        let currentFilter = 'all';

        async function getTopRatedDoctors(limit = 3) {
            try {
                const ratingsSnapshot = await getDocs(collection(db, "ratings"));
                const doctorRatings = {};

                ratingsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const { doctorEmail, rating } = data;

                    if (!doctorRatings[doctorEmail]) {
                        doctorRatings[doctorEmail] = { total: 0, count: 0 };
                    }

                    doctorRatings[doctorEmail].total += rating;
                    doctorRatings[doctorEmail].count += 1;
                });

                const sortedDoctors = Object.entries(doctorRatings)
                    .map(([email, { total, count }]) => ({
                        email,
                        average: total / count
                    }))
                    .sort((a, b) => b.average - a.average)
                    .slice(0, limit);

                return sortedDoctors.map(d => d.email);
            } catch (error) {
                console.error("Error getting top rated doctors:", error);
                return [];
            }
        }

        async function loadDoctors() {
            const container = document.getElementById('doctorsContainer');
            if (!container) return;

            try {
                const topDoctorEmails = await getTopRatedDoctors();
                const querySnapshot = await getDocs(collection(db, "doctors"));

                allDoctors = [];
                querySnapshot.forEach((doc) => {
                    allDoctors.push({
                        id: doc.id,
                        data: doc.data(),
                        isTopRated: topDoctorEmails.includes(doc.data().email)
                    });
                });

                displayDoctors(allDoctors);
                updateResultsInfo(allDoctors.length, allDoctors.length);
            } catch (error) {
                console.error("Error loading doctors:", error);
            }
        }

        function displayDoctors(doctors) {
            const container = document.getElementById('doctorsContainer');
            container.innerHTML = '';

            doctors.forEach(({ id, data: doctor, isTopRated }) => {
                const card = document.createElement("div");
                card.className = "card";
                card.setAttribute('data-doctor-name', doctor.fullName || '');
                card.setAttribute('data-specialization', doctor.specialization || '');
                card.setAttribute('data-hospital', doctor.hospitalName || '');

                let scheduleHTML = "";
                if (doctor.schedule && doctor.schedule.length > 0) {
                    const groupedByDay = {};

                    doctor.schedule.forEach(entry => {
                        if (!groupedByDay[entry.day]) groupedByDay[entry.day] = [];
                        if (entry.startTime && entry.endTime) groupedByDay[entry.day].push(`${entry.startTime} - ${entry.endTime}`);
                    });

                    let dayRow = "";
                    let timeRows = [];
                    const maxSlots = Math.max(...Object.values(groupedByDay).map(times => times.length));

                    Object.keys(groupedByDay).forEach(day => {
                        dayRow += `<div class="day-cell">${day.slice(0, 3)}</div>`;
                    });

                    for (let i = 0; i < maxSlots; i++) {
                        let row = "";
                        Object.keys(groupedByDay).forEach(day => {
                            const timeRange = groupedByDay[day][i] || "";
                            row += `<div class="time-cell">${timeRange}</div>`;
                        });
                        timeRows.push(`<div class="schedule-grid">${row}</div>`);
                    }

                    scheduleHTML = `<div class="schedule-grid">${dayRow}</div>${timeRows.join('')}`;
                } else {
                    scheduleHTML = "<p>No available schedule</p>";
                }

                const profileImage = doctor.profileImageURL || "doctor1.png";

                card.innerHTML = `
                    <div class="card-body">
                        <div class="image-wrapper">
                            <img src="${profileImage}" alt="Doctor">
                            ${isTopRated ? '<div class="badge">Leading Doctor</div>' : ''}
                        </div>
                        <div class="info-container">
                            <div class="doctor-info">
                                <h2 class="doctor-name">${doctor.fullName || 'Unnamed Doctor'}</h2>
                                <p class="doctor-spec">${doctor.specialization || ''}</p>
                                <p class="doctor-hospital"><strong>Hospital:</strong> ${doctor.hospitalName || 'Not specified'}</p>
                                <p class="doctor-address"><strong>Address:</strong> ${doctor.hospitalAddress || 'Not provided'}</p>
                            </div>
                        </div>

                        <div class="schedule">
                            <p>Consultation Schedule:</p>
                            <div class="slots-times">${scheduleHTML}</div>
                        </div>

                        <p class="doctor-review">${doctor.bio || ''}</p>
                    </div>
                `;

                const button = document.createElement("button");
                button.className = "book-btn";
                button.textContent = "Book Appointment";
                button.addEventListener("click", () => {
                    window.location.href = `appointmentBooking.html?doctorId=${id}`;
                });

                card.appendChild(button);
                container.appendChild(card);
            });
        }

        function filterDoctors() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.card');
            let visibleCount = 0;

            cards.forEach(card => {
                const doctorName = card.getAttribute('data-doctor-name').toLowerCase();
                const specialization = card.getAttribute('data-specialization').toLowerCase();
                const hospital = card.getAttribute('data-hospital').toLowerCase();

                const matchesSearch = doctorName.includes(searchTerm) ||
                    specialization.includes(searchTerm) ||
                    hospital.includes(searchTerm);

                const matchesFilter = currentFilter === 'all' ||
                    specialization.includes(currentFilter.toLowerCase());

                if (matchesSearch && matchesFilter) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });

            updateResultsInfo(visibleCount, allDoctors.length);
            toggleNoResults(visibleCount === 0);
        }

        function updateResultsInfo(visible, total) {
            const resultsInfo = document.getElementById('resultsInfo');
            if (visible === total) {
                resultsInfo.textContent = `Showing ${total} doctor${total !== 1 ? 's' : ''}`;
            } else {
                resultsInfo.textContent = `Showing ${visible} of ${total} doctor${total !== 1 ? 's' : ''}`;
            }
        }

        function toggleNoResults(show) {
            const noResults = document.getElementById('noResults');
            const container = document.getElementById('doctorsContainer');

            if (show) {
                noResults.style.display = 'block';
                container.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                container.style.display = 'flex';
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterDoctors);

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Update active filter button
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                // Update current filter
                currentFilter = e.target.getAttribute('data-filter');

                // Apply filter
                filterDoctors();
            });
        });

        // Initialize
        window.addEventListener("DOMContentLoaded", loadDoctors);
    </script>
    @
    <script>
        function toggleMenu() {
            const menu = document.getElementById("hiddenMenu");
            menu.classList.toggle("active");
        }

        document.addEventListener('click', function (event) {
            const menu = document.getElementById('hiddenMenu');
            const icon = document.querySelector('.menu-icon');
            if (event.target !== menu && event.target !== icon && !menu.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        window.toggleMenu = toggleMenu;
    </script>
</body>

</html>