<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctor Dashboard</title>
  <link rel="stylesheet" href="doctor-styles.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
</head>

<body>
  <div class="dashboard-container">
    <header>
      <div class="doctor-info">
        <img src="pfp.PNG" alt="Doctor Profile" id="profileImage" />
        <div class="doctor-details">
          <h1 id="fullNameDisplay">Loading...</h1>
          <p class="doctor-spec" id="specializationDisplay">Loading...</p>
        </div>
      </div>
      <div class="notifications">
        <span class="notification-icon">
            <i class="fas fa-bell">
            <span class="notification-count" id="notificationCount">0</span>
            </i>
        </span>
        <div class="notification-dropdown" id="notificationDropdown">
            <!-- Notifications will be injected here -->
        </div>
      </div>
    </header>

    <aside>
      <nav>
        <ul>
          <li><a href="doctorDashboard.html">Dashboard</a></li>
          <li><a href="doctorDetails.html">Profile</a></li>
          <li><a href="patients.html">Patients</a></li>
          <li><a href="reports.html">Reports</a></li>
        </ul>
      </nav>
    </aside>

    <main>
      <section class="schedule">
        <h2>Appointment</h2>
        <table>
          <thead>
            <tr>
              <th>Date and Time</th>
              <th>Patient Name</th>
              <th>Reason</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </main>

    <footer>
      <p>&copy; 2025 Doctor Dashboard</p>
    </footer>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    getDoc,
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDwCayQZ0JO6DjzQvAT6ToT33I4QXCS_NY",
    authDomain: "login-sample-c3af0.firebaseapp.com",
    projectId: "login-sample-c3af0",
    storageBucket: "login-sample-c3af0.appspot.com",
    messagingSenderId: "372688128666",
    appId: "1:372688128666:web:bbc529c73c4665f95f6d23",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  const fullNameEl = document.getElementById("fullNameDisplay");
  const specializationEl = document.getElementById("specializationDisplay");
  const profileImageEl = document.getElementById("profileImage");
  const appointmentTableBody = document.querySelector("tbody");
  const notificationDropdown = document.getElementById("notificationDropdown");
  const notificationCount = document.getElementById("notificationCount");

  async function loadDoctorInfo(doctorId) {
    try {
      const docRef = doc(db, "doctors", doctorId);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        fullNameEl.textContent = data.fullName || "No name found";
        specializationEl.textContent = data.specialization || "No specialization found";
        if (data.profileImageUrl) {
          profileImageEl.src = data.profileImageUrl;
        }
      } else {
        fullNameEl.textContent = "Doctor not found";
        specializationEl.textContent = "";
        console.warn("No doctor document found!");
      }
    } catch (error) {
      console.error("Error fetching doctor info:", error);
    }
  }

  async function loadAppointments() {
    try {
      const querySnapshot = await getDocs(collection(db, "approved"));
      const now = new Date();
      appointmentTableBody.innerHTML = "";
      notificationDropdown.innerHTML = "";
      let upcomingCount = 0;

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const dateStr = data.appointmentDateTime || data.timestamp;

        const appointmentDate = new Date(dateStr);
        if (isNaN(appointmentDate) || appointmentDate < now) return;

        // Table row
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${appointmentDate.toLocaleString([], {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          })}</td>
          <td>${data.fullName || "N/A"}</td>
          <td>${data.reason || "N/A"}</td>
          <td><a href="patient-details.html?id=${docSnap.id}" data-patient-id="${docSnap.id}">View Details</a></td>
        `;
        appointmentTableBody.appendChild(row);

        // Notifications for tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(now.getDate() + 1);
        const isTomorrow =
          appointmentDate.getDate() === tomorrow.getDate() &&
          appointmentDate.getMonth() === tomorrow.getMonth() &&
          appointmentDate.getFullYear() === tomorrow.getFullYear();

        if (isTomorrow) {
          upcomingCount++;
          const notifItem = document.createElement("div");
          notifItem.classList.add("notification-item");
          notifItem.innerHTML = `
            <strong>${data.fullName}</strong> has an appointment<br/>
            <small>${appointmentDate.toLocaleString([], {
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            })}</small>
          `;
          notificationDropdown.appendChild(notifItem);
        }
      });

      if (!appointmentTableBody.hasChildNodes()) {
        appointmentTableBody.innerHTML =
          "<tr><td colspan='4'>No upcoming approved appointments.</td></tr>";
      }

      notificationCount.textContent = upcomingCount;
      notificationCount.style.display = upcomingCount > 0 ? "inline-block" : "none";
    } catch (error) {
      console.error("Error loading approved appointments:", error);
    }
  }

  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("Logged in as", user.email);
      loadDoctorInfo(user.uid);
      loadAppointments(); // no doctorId filtering
    } else {
      fullNameEl.textContent = "Please log in";
      specializationEl.textContent = "";
      appointmentTableBody.innerHTML =
        "<tr><td colspan='4'>You must be logged in to view appointments.</td></tr>";
    }
  });
</script>

</body>

</html>